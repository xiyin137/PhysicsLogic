name: ci

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  lean:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install prerequisites
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            echo "apt attempt ${i}/3"
            if sudo apt-get update && sudo apt-get install -y ripgrep; then
              break
            fi
            if [ "$i" -eq 3 ]; then
              echo "failed to install prerequisites after retries"
              exit 1
            fi
            sleep 5
          done

      - name: Install elan
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            echo "elan install attempt ${i}/3"
            if curl -fL https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -o /tmp/elan-init.sh \
              && sh /tmp/elan-init.sh -y; then
              break
            fi
            if [ "$i" -eq 3 ]; then
              echo "failed to install elan after retries"
              exit 1
            fi
            sleep 5
          done
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"

      - name: Install Lean toolchain
        run: |
          set -euo pipefail
          export PATH="$HOME/.elan/bin:$PATH"
          toolchain="$(cat lean-toolchain)"
          for i in 1 2 3; do
            echo "toolchain install attempt ${i}/3: ${toolchain}"
            if elan toolchain install "$toolchain"; then
              break
            fi
            if [ "$i" -eq 3 ]; then
              echo "failed to install Lean toolchain after retries"
              exit 1
            fi
            sleep 5
          done
          elan default "$toolchain"

      - name: Toolchain versions
        run: |
          set -euo pipefail
          export PATH="$HOME/.elan/bin:$PATH"
          elan --version
          rg --version
          lean --version
          lake --version

      - name: Download mathlib cache (best effort)
        run: |
          set -euo pipefail
          ok=0
          for i in 1 2 3; do
            echo "cache attempt ${i}/3"
            if lake exe cache get; then
              ok=1
              break
            fi
            sleep 5
          done
          if [ "$ok" -eq 0 ]; then
            echo "cache download unavailable; continuing with source build"
          fi

      - name: Invariant checks
        run: bash scripts/check_nonpapers_invariants.sh

      - name: Physics assumptions registry check
        run: bash scripts/check_physics_assumptions_registry.sh

      - name: Physics assumption usage check
        run: bash scripts/check_physics_assumption_usage.sh

      - name: Generate assumptions report
        run: |
          set -euo pipefail
          mkdir -p artifacts
          bash scripts/assumptions_report.sh artifacts/assumptions_report.md
          sed -n '1,80p' artifacts/assumptions_report.md

      - name: Upload assumptions report artifact
        uses: actions/upload-artifact@v4
        with:
          name: assumptions-report
          path: artifacts/assumptions_report.md

      - name: No-new-sorry check (non-Papers)
        run: bash scripts/check_no_new_nonpapers_sorry.sh

      - name: Non-Papers sorry budget check
        run: bash scripts/check_nonpapers_sorry_budget.sh

      - name: Build strict core target
        run: lake build PhysicsLogic.Core

      - name: Build papers target
        run: lake build PhysicsLogic.Papers

      - name: Build compatibility umbrella target
        run: lake build PhysicsLogic
